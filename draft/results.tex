\begin{lemma}[Kinding for Typing]
  \label{lemma:kinding_for_typing}
  If $[[G |- t : A]]$, then $[[G |- A : *]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction the on form of $[[G |- t : A]]$.
\end{proof}

\begin{lemma}[Strengthening for Kinding]
  \label{lemma:strengthening_for_kinding}
  If $[[G, x : A |- B : *]]$, then $[[G |- B : *]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on the form of $[[G, x : A |- B : *]]$.
\end{proof}

\begin{lemma}[Inclusion of Bounded System F]
  \label{lemma:F-inclusion}
  Suppose $t$ is fully annotated and does not contain any applications
  of $[[box]]$ or $[[unbox]]$, and $[[A]]$ is static.  Then
  \begin{itemize}
  \item[i.] $[[G |-F t : A]]$ if and only if $\,[[G |- t : A]]$, and 
  \item[ii.] $[[t F~>* t']]$ if and only if $[[t ~>* t']]$.
  \end{itemize}
\end{lemma}
\begin{proof}
  We give proof sketches for both parts.  The interesting cases are
  the right-to-left directions of each part.  If we simply remove all
  rules mentioning the unknown type $[[?]]$ and the type consistency
  relation, and then remove $[[box]]$, $[[unbox]]$, and $[[?]]$ from
  the syntax of Surface Grady, then what we are left with is bounded
  system F.  Since $[[t]]$ is fully annotated and $[[A]]$ is static,
  then $[[G |- t : A]]$ will hold within this fragment.

  Moving on to part two, first, we know that $[[t]]$ does not contain
  any occurrence of $[[box]]$ or $[[unbox]]$ and is fully annotated.
  This implies that $[[t]]$ lives within the bounded system F fragment
  of Surface Grady. Thus, before evaluation of $[[t]]$ Surface Grady
  will apply the cast insertion algorithm which will at most insert
  applications of the identity function into $[[t]]$ producing a term
  $\widehat{[[t]]}$, but then after potentially more than one step of
  evaluation within Core Grady, those applications of the identity
  function will be $\beta$-reduced away resulting in $\widehat{[[t]]}
  \rightsquigarrow^* [[t]] \rightsquigarrow^* [[t']]$.  In addition,
  since $[[t]]$ in Surface Grady is the exact same program as $[[t]]$
  in bounded system F, then we know $[[t F~>* t']]$ will hold.
\end{proof}

\begin{lemma}[Inclusion of DTLC]
  \label{lemma:inclusion_of_dtlc}
  Suppose $[[t]]$ is a closed term of DTLC. Then
  \begin{itemize}
  \item[i.] $[[. |- |t| : ?]]$, and
  \item[ii.] $[[t D~>* t']]$ if and only if $[[|t| ~>* |t'|]]$.
  \end{itemize}
\end{lemma}
\begin{proof}
  In this case DTLC is embedded into the simply typed fragment of
  Grady, and hence, this proof is the same result proven by
  \cite{Siek:2006}, and \cite{Siek:2015}.
\end{proof}

\renewcommand{\SGradydrulePXXUName}{[[?]]}
\renewcommand{\SGradydrulePXXreflName}{\text{refl}}
\renewcommand{\SGradydrulePXXarrowName}{\to}
\renewcommand{\SGradydrulePXXprodName}{\times}
\renewcommand{\SGradydrulePXXlistName}{\mathsf{List}}
\renewcommand{\SGradydrulePXXforallName}{\forall}
\begin{figure}
  \begin{mdframed}
    \begin{mathpar}
      \SGradydrulePXXU{} \and
      \SGradydrulePXXrefl{} \and
      \SGradydrulePXXarrow{} \and
      \SGradydrulePXXprod{} \and
      \SGradydrulePXXlist{} \and
      \SGradydrulePXXforall{}      
    \end{mathpar}
  \end{mdframed}
  \caption{Type Precision}
  \label{fig:type-pre}
\end{figure}

\begin{lemma}[Symmetry for Type Consistency]
  \label{lemma:symmetry_for_type_consistency}
  If $[[G |- A ~ B]]$, then $[[G |- B ~ A]]$.
\end{lemma}
\begin{proof}
  This holds by straightforward induction on the form of $[[G |- A ~ B]]$.
\end{proof}

\begin{lemma}[Inversion for Type Precision]
  \label{lemma:inversion_of_type_precision}
  Suppose $[[G |- A : *]]$, $[[G |- B : *]]$, and $[[A <= B]]$.  Then:
  \begin{enumR}
  \item if $[[A]] = [[?]]$, then $[[G |- B <~ SL]]$.
  \item if $[[A]] = [[A1 -> B1]]$, then
    $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or $[[B]] = [[A2 -> B2]]$, $[[A1 <= A2]]$, and $[[B1 <= B2]]$.
  \item if $[[A]] = [[A1 x B1]]$, then
    $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or $[[B]] = [[A2 x B2]]$, $[[A1 <= A2]]$, and $[[B1 <= B2]]$.
  \item if $[[A]] = [[List A1]]$, then
    $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or $[[B]] = [[List A2]]$ and $[[A1 <= A2]]$.
  \item if $[[A]] = [[Forall (X <: A1).B1]]$, then
    $[[B]] = [[Forall (X <: A1).B1]]$ and $[[B1 <= B2]]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on the form of $[[A <= B]]$.
\end{proof}

\begin{lemma}[Inversion for Term Precision]
  \label{lemma:inversion_of_term_precision}
  Suppose $[[t <= t']]$. Then:
  \begin{enumR}
  \item if $[[t]] = [[succ t1]]$, then $[[t']] = [[succ t2]]$ and $[[t1 <= t2]]$.
  \item if $[[t]] = [[(case t1 of 0 -> t2, (succ x) -> t3)]]$, then
    $[[t']] = [[(case t1' of 0 -> t2', (succ x) -> t3')]]$, $[[t1 <= t1']]$, $[[t2 <= t2']]$, and $[[t3 <= t3']]$.
  \item if $[[t]] = [[(t1,t2)]]$, then $[[t']] = [[(t1',t2')]]$, $[[t1 <= t1']]$, and $[[t2 <= t2']]$.
  \item if $[[t]] = [[fst t1]]$, then $[[t']] = [[fst t1']]$ and $[[t1 <= t1']]$.
  \item if $[[t]] = [[snd t1]]$, then $[[t']] = [[snd t1']]$ and $[[t1 <= t1']]$.
  \item if $[[t]] = [[t1::t2]]$, then $[[t']] = [[t1'::t2']]$, $[[t1 <= t1']]$, and $[[t2 <= t2']]$.
  \item if $[[t]] = [[(case t1 of [] -> t2, (x::y) -> t3)]]$, then
    $[[t']] = [[(case t1' of [] -> t2', (x::y) -> t3')]]$, $[[t1 <= t1']]$, $[[t2 <= t2']]$, and $[[t3 <= t3']]$.
  \item if $[[t]] = [[\x:A1.t1]]$, then $[[t']] = [[\x:A1.t1']]$ and $[[t1 <= t1']]$.
  \item if $[[t]] = [[(t1 t2)]]$, then $[[t']] = [[(t1' t2')]]$, $[[t1 <= t1']]$, and $[[t2 <= t2']]$.
  \item if $[[t]] = [[Lam X <: A1.t1]]$, then $[[t']] = [[Lam X <: A1.t1']]$ and $[[t1 <= t1']]$.
  \item if $[[t]] = [[ [A]t1]]$, then $[[t']] = [[ [A]t1']]$ and $[[t1 <= t1']]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on the form of $[[t <= t']]$.
\end{proof}

\begin{lemma}[Inversion for Type Consistency]
  \label{lemma:inversion_of_type_consistency}
  Suppose $[[G |- A ~ B]]$. Then:
  \begin{enumR}
  \item if $[[A]] = [[?]]$, then $[[G |- B <~ SL]]$.
  \item if $[[A]] = [[List A']]$, then $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or
    $[[B]] = [[List B']]$ and $[[G |- A' ~ B']]$.
  \item if $[[A]] = [[A1 -> B1]]$, then $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or
    $[[B]] = [[A2 -> B2]]$, $[[G |- A2 ~ A1]]$, and $[[G |- B1 ~ B2]]$.
  \item if $[[A]] = [[A1 -> B1]]$, then $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or
    $[[B]] = [[A2 -> B2]]$, $[[G |- A2 ~ A1]]$, and $[[G |- B1 ~ B2]]$.
  \item if $[[A]] = [[A1 x B1]]$, then $[[B]] = [[?]]$ and $[[G |- A <~ SL]]$, or
    $[[B]] = [[A2 x B2]]$, $[[G |- A1 ~ A2]]$, and $[[G |- B1 ~ B2]]$.
  \item if $[[A]] = [[Forall (X <: A1).B1]]$, then $[[B]] = [[Forall (X <: A1).B2]]$ and $[[G, X <: A1 |- B1 ~ B2]]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on the the form of $[[G |- A ~ B]]$.
\end{proof}

\begin{lemma}[Inversion for Consistent Subtyping]
  \label{lemma:inversion_of_consistent_subtyping}
  Suppose $[[G |- A <~ B]]$. Then:
  \begin{enumR}
  \item if $[[A]] = [[?]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ or $[[G |- B <~ SL]]$.
  \item if $[[A]] = [[X]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, or $[[X <: B' elem G]]$ and $[[G |- B' ~ B]]$.
  \item if $[[A]] = [[Nat]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, or $[[B]] = [[SL]]$.
  \item if $[[A]] = [[Unit]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, or $[[B]] = [[SL]]$.
  \item if $[[A]] = [[List A1]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, $[[B]] = [[SL]]$ and $[[G |- A1 <~ SL]]$,
    or $[[B]] = [[List A1']]$ and $[[G |- A1 <~ A1']]$.
  \item if $[[A]] = [[A1 -> B1]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, $[[B]] = [[SL]]$, $[[G |- A1 <~ SL]]$ and
    $[[G |- B1 <~ SL]]$, or $[[B]] = [[A1' -> B1']]$, $[[G |- A1' <~ A1]]$, and $[[G |- B1 <~ B1']]$.
  \item if $[[A]] = [[A1 x B1]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$, $[[B]] = [[SL]]$, $[[G |- A1 <~ SL]]$ and
    $[[G |- B1 <~ SL]]$, or $[[B]] = [[A1' x B1']]$, $[[G |- A1 <~ A1']]$, and $[[G |- B1 <~ B1']]$.
  \item if $[[A]] = [[Forall (X <: A1).B1]]$, then
    $[[B]] = [[A]]$ and $[[G |- A : *]]$, $[[B]] = [[Top]]$ and $[[G |- A : *]]$,
    or $[[B]] = [[Forall (X <: A1).B1']]$ and $[[G, X <: A1 |- B1 <~ B1']]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on the the form of $[[G |- A <~ B]]$.
\end{proof}

\begin{lemma}
  \label{lemma:consistent-subtyping-1}
  Suppose $[[G |- A <~ B]]$.
  \begin{enumR}
    \item $[[G |- A ~ A']]$ and $<<G |- A' <: B>>$ for some $[[A']]$.
    \item $[[G |- B' ~ B]]$ and $<<G |- A <: B'>>$ for some $[[B']]$.
  \end{enumR}   
\end{lemma}
\begin{proof}
  This is a proof by induction on $[[G |- A <~ B]]$.  We only show a
  few of the most interesting cases.
  \begin{itemize}
  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleSXXBoxName{}$] {
          [[G |- A <~ SL]]
        }{[[G |- A <~ ?]]}
      \end{math}
    \end{center}
    In this case $[[B]] = [[?]]$.

    \noindent
    \textbf{Part i.} Choose $[[A']] = [[?]]$.

    \noindent
    \textbf{Part ii.} Choose $[[B']] = [[A]]$.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleSXXUnboxName{}$] {
          [[G |- B <~ SL]]
        }{[[G |- ? <~ B]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[?]]$.

    \noindent
    \textbf{Part i.} Choose $[[A']] = [[B]]$.

    \noindent
    \textbf{Part ii.} Choose $[[B']] = [[?]]$.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleSXXArrowName{}$] {
          [[G |- A2 <~ A1 && G |- B1 <~ B2]]
        }{[[G |- (A1 -> B1) <~ (A2 -> B2)]]}
      \end{math}
    \end{center}

    In this case $[[A]] = [[A1 -> B1]]$ and $[[B]] = [[A2 -> B2]]$.

    \noindent
    \textbf{Part i.} By part two of the induction hypothesis we know
    that $[[G |- A1' ~ A1]]$ and $<<G |- A2 <: A1'>>$, and by part one of the induction hypothesis
    $[[G |- B1 ~ B1']]$ and $<<G |- B1' <: B2>>$.  By symmetry of type consistency
    we may conclude that $[[G |- A1 ~ A1']]$ which along with $[[G |- B1 ~ B1']]$
    implies that $[[G |- (A1 -> B1) ~ (A1' -> B1')]]$, and by reapplying the rule
    we may conclude that $<<G |- (A1' -> B1') <: (A2 -> B2)>>$.

    \noindent
    \textbf{Part ii.} Similar to part one, except that we first
    applying part one of the induction hypothesis to the first
    premise, and then the second part to the second premise.
    
  \end{itemize}

\end{proof}

\begin{lemma}
  \label{lemma:consistent-subtyping-2}
  If $<<G |- A <: B>>$, then $[[G |- A <~ B]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on $<<G |- A <: B>>$.
\end{proof}

\begin{lemma}
  \label{lemma:consistent-subtyping-3}
  if $[[G |- A ~ B]]$, then $[[G |- A <~ B]]$.
\end{lemma}
\begin{proof}
  By straightforward induction on $[[G |- A ~ B]]$.
\end{proof}

\begin{lemma}[Type Precision and Consistency]
  \label{lemma:type_precision_and_consistency}
  Suppose $[[G |- A : *]]$ and $[[G |- B : *]]$.  Then
  if $[[A <= B]]$, then $[[G |- A ~ B]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on $[[A <= B]]$.
\end{proof}

\begin{corollary}[Type Precision and Subtyping]
  \label{corollary:type_precision_and_subtyping}
  Suppose $[[G |- A : *]]$ and $[[G |- B : *]]$.  Then
  if $[[A <= B]]$, then $[[G |- A <~ B]]$.
\end{corollary}
\begin{proof}
  This easily follows from the previous two lemmas.
\end{proof}

\begin{corollary}[Consistent Subtyping]
  \label{corollary:consistent_subtyping}
  \begin{enumR}
  \item[]
  \item $[[G |- A <~ B]]$ if and only if $[[G |- A ~ A']]$ and $<<G |- A' <: B>>$ for some $[[A']]$.
  \item $[[G |- A <~ B]]$ if and only if $[[G |- B' ~ B]]$ and $<<G |- A <: B'>>$ for some $[[B']]$.
  \end{enumR}
\end{corollary}
\begin{proof}
  The left-to-right direction of both cases easily follows from
  Lemma~\ref{lemma:consistent-subtyping-1}, and the right-to-left
  direction of both cases follows from induction on the subtyping
  derivation and Lemma~\ref{lemma:simply_typed_consistent_types_are_subtypes}.
\end{proof}

\begin{lemma}
  \label{lemma:type_precision_triangle_consistenty}
  Suppose $[[G |- A : *]]$, $[[G |- B : *]]$, and $[[G |- C : *]]$.
  If $[[A <= B]]$ and $[[A <= C]]$, then $[[G |- B ~ C]]$.
\end{lemma}
\begin{proof}
  It must be the case that either $[[B <= C]]$ or $[[C <= B]]$, but in both cases
  we know $[[G |- B ~ C]]$ by Lemma~\ref{lemma:type_precision_and_consistency}.
\end{proof}

\begin{lemma}[Transitivity for Type Precision]
  \label{lemma:transitivity_for_type_precision}
  If $[[A <= B]]$ and $[[B <= C]]$, then $[[A <= C]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on $[[A <= B]]$ with
  a case analysis over $[[B <= C]]$.
\end{proof}

\begin{lemma}
  \label{lemma:type_consistency_to_type_precision}
  If $[[G |- A ~ B]]$, then $[[A <= B]]$ or $[[B <= A]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction over $[[G |- A ~ B]]$.
\end{proof}

\begin{lemma}
  \label{lemma:cons_subtype_to_type_pre}
  If $[[G |- A <~ B]]$ and $[[A <= A']]$, then $[[B <= A']]$ or $[[A' <= B]]$.
\end{lemma}
\begin{proof}
  Suppose $[[G |- A <~ B]]$ and $[[A <= A']]$.  The former implies
  that $[[A <= B]]$ or $[[B <= A]]$ by
  Lemma~\ref{lemma:consistent-subtyping-1} and
  Lemma~\ref{lemma:type_consistency_to_type_precision}.  At this
  point the result easily follows.
\end{proof}

\begin{lemma}
  \label{lemma:fun_type_pre}
  Suppose $[[A <= B]]$.  Then
  \begin{enumR}
  \item If $[[nat(A) = Nat]]$, then $[[nat(B) = Nat]]$.    
  \item If $[[list(A) = List C]]$, then $[[list(B) = List C']]$ and $[[C <= C']]$.
  \item If $[[fun(A) = A1 -> A2]]$, then $[[fun(B) = A1' -> A2']]$, $[[A1 <= A1']]$, and $[[A2 <= A2']]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on $[[A <= B]]$.
\end{proof}

\begin{lemma}
  \label{lemma:type_cons_type_pre_2}
  If $[[G |- A ~ B]]$, $[[G |- C : *]]$, and $[[A <= C]]$, then $[[G |- C ~ B]]$.
\end{lemma}
\begin{proof}
  Suppose $[[G |- A ~ B]]$ and $[[A <= C]]$.  Then we know
  that $[[A <= B]]$ or $[[B <= A]]$.  If the former, then
  we know that $[[G |- C ~ B]]$.  If the latter, then
  we obtain $[[B <= C]]$ by transitivity, and $[[G |- B ~ C]]$
  which implies that $[[G |- C ~ B]]$ by symmetry.
\end{proof}

\begin{lemma}
  \label{lemma:type_cons_ctx_pre}
  If $[[G' Ok]]$, $[[G <= G']]$ and $[[G |- A ~ B]]$, then $[[G' |- A ~ B]]$.
\end{lemma}
\begin{proof}
  This proof holds by straightforward induction on $[[G |- A ~ B]]$. 
\end{proof}

\begin{lemma}[Subtyping Context Precision]
  \label{lemma:subtyping_context_precision}
  If $[[G |- A <~ B]]$ and $[[G <= G']]$, then $[[G' |- A <~ B]]$.
\end{lemma}
\begin{proof}
  Context precision does not manipulate the bounds on type variables, and thus,
  with respect to subtyping $[[G]]$ and $[[G']]$ are essentially equivalent.
\end{proof}

\begin{lemma}[Simply Typed Consistent Types are Subtypes of $[[SL]]$]
  \label{lemma:simply_typed_consistent_types_are_subtypes}
  If $[[G |- A <~ SL]]$ and $[[G |- A ~ B]]$, then $[[G |- B <~ SL]]$.
\end{lemma}
\begin{proof}
  This holds by straightforward induction on the form of $[[G |- A <~ SL]]$.
\end{proof}

\begin{lemma}[Type Precision Preserves $[[SL]]$]
  \label{lemma:type_precision_preserves_SL}
  \begin{enumR}
  \item[]
  \item If $[[G |- B : *]]$, $[[G |- A <~ SL]]$ and $[[A <= B]]$, then $[[G |- B <~ SL]]$.
  \item If $[[G |- A : *]]$, $[[G |- B <~ SL]]$ and $[[A <= B]]$, then $[[G |- A <~ SL]]$.
  \end{enumR}
\end{lemma}
\begin{proof}
  Both cases follow by induction on the assumed consistent subtyping
  derivation.
\end{proof}

\begin{lemma}[Congruence of Type Consistency Along Type Precision]
  \label{lemma:congruence_of_type_consistency_along_type_precision}
  \begin{enumR}
  \item[] 
  \item If $[[A1 <= A1']]$ and $[[G |- A1 ~ A2]]$ then
    $[[G |- A1' ~ A2]]$.
    
  \item If $[[A2 <= A2']]$ and $[[G |- A1 ~ A2]]$ then
    $[[G |- A1 ~ A2']]$.  
  \end{enumR}
\end{lemma}
\begin{proof}
  The proofs of both parts are similar, and so we only show a few
  cases of the first part, but the omitted cases follow similarly.

  \noindent
  \textbf{Proof of part one.} This is a proof by induction on the form
  of $[[A1 <= A1']]$.
  \begin{itemize}
  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydrulePXXUName{}$] {
          [[G |- A1 <~ SL]]
        }{[[A1 <= ?]]}
      \end{math}
    \end{center}
    In this case $[[A1']] = [[?]]$.  Suppose $[[G |- A1 ~ A2]]$.  Then
    it suffices to show that $[[G |- ? ~ A2]]$, and hence, we must show
    that $[[G |- A2 <~ SL]]$, but this follows by Lemma~\ref{lemma:simply_typed_consistent_types_are_subtypes}.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydrulePXXarrowName{}$] {
          [[A <= C && B <= D]]
        }{[[(A -> B) <= (C -> D)]]}
      \end{math}
    \end{center}
    In this case $[[A1]] = [[A -> B]]$ and $[[A1']] = [[C -> D]]$.  Suppose
    $[[G |- A1 ~ A2]]$.  Then by inversion for type consistency it must
    be the case that either $[[A2]] = [[?]]$ and $[[G |- A1 <~ SL]]$, or
    $[[A2]] = [[A' -> B']]$, $[[G |- A ~ A']]$, and $[[G |- B ~ B']]$.
   
    Consider the former.  Then it suffices to show that $[[G |- A1' ~ ?]]$,
    and hence we must show that $[[G |- A1' <~ SL]]$, but this follows
    from Lemma~\ref{lemma:type_precision_preserves_SL}.

    Consider the case when $[[A2]] = [[A' -> B']]$, $[[G |- A ~ A']]$, and $[[G |- B ~ B']]$.
    It suffices to show that $[[G |- (C -> D) ~ (A' -> B')]]$ which follows from
    $[[G |- A' ~ C]]$ and $[[G |- D ~ B']]$.  Thus, it suffices to show that latter.
    By assumption we know the following:
    \begin{center}
      \begin{tabular}{lll}
        $[[A <= C]]$ and $[[G |- A ~ A']]$\\
        $[[B <= D]]$ and $[[G |- B ~ B']]$
      \end{tabular}
    \end{center}
    Now by two applications of the induction hypothesis we obtain $[[G |- C ~ A']]$
    and $[[G |- D ~ B']]$. By symmetry the former implies $[[G |- A ~ C]]$ and
    we obtain our result.
  \end{itemize}  
\end{proof}

\begin{corollary}[Congruence of Type Consistency Along Type Precision Condensed]
  \label{corollary:congruence_of_type_consistency_along_type_precision}
  If $[[A1 <= A1']]$, $[[A2 <= A2']]$, and $[[G |- A1 ~ A2]]$ then
  $[[G |- A1' ~ A2']]$.  
\end{corollary}

\begin{lemma}[Congruence of Subtyping Along Type Precision]
  \label{lemma:congruence_of_subtyping_along_type_precision}
  Suppose $[[G |- B : *]]$ and $[[A <= B]]$.
  \begin{enumR}
  \item If $[[G |- A <~ C]]$ then $[[G |- B <~ C]]$.

  \item If $[[G |- C <~ A]]$ then $[[G |- C <~ B]]$.  
  \end{enumR}
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of $[[A <= B]]$.  The proof
  of part two follows similarly to part one.
  
  \noindent
  \textbf{Proof of part one.}  We only show the most interesting case,
  because all others are similar.
  \begin{itemize}    

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydrulePXXarrowName{}$] {
          [[A1 <= A2 && B1 <= B2]]
        }{[[(A1 -> B1) <= (A2 -> B2)]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[A1 -> B1]]$ and $[[B]] = [[A2 -> B2]]$.
    Suppose $[[G |- A <~ C]]$.  Thus, by inversion for consistency subtyping
    it must be the case that $[[C]] = [[Top]]$ and $[[G |- A : *]]$, $[[C]] = [[?]]$ and $[[G |- A <~ SL]]$, or
    $[[C]] = [[A1' -> B1']]$, $[[G |- A1' <~ A1]]$, and $[[G |- B1 <~ B1']]$.  The case when $[[C]] = [[Top]]$
    is trivial, and the case when $[[C]] = [[?]]$ is similarly to the proof of
    Lemma~\ref{lemma:congruence_of_type_consistency_along_type_precision}.

    Consider the case when $[[C]] = [[A1' -> B1']]$, $[[G |- A1' <~ A1]]$, and $[[G |- B1 <~ B1']]$.
    By assumption we know the following:
    \begin{center}
      \begin{tabular}{lll}
        $[[A1 <= A2]]$ and $[[G |- A1' <~ A1]]$\\
        $[[B1 <= B2]]$ and $[[G |- B1 <~ B1']]$
      \end{tabular}
    \end{center}
    So by part two and one, respectively, of the induction hypothesis we know
    that $[[G |- A1' <~ A2]]$ and $[[G |- B2 <~ B1']]$.  Thus, by reapplying the rule above
    we may now conclude that $[[G |- (A2 -> B2) <~ (A1' -> B2')]]$ to obtain our result.
  \end{itemize}
\end{proof}

\begin{corollary}[Congruence of Subtyping Along Type Precision]
  \label{corollary:congruence_of_subtyping_along_type_precision}
  If $[[A1 <= A2]]$, $[[B1 <= B2]]$, and $[[G |- A1 <~ B1]]$, then $[[G |- A2 <~ B2]]$.
\end{corollary}

\begin{lemma}[Gradual Guarantee Part One]
  \label{lemma:gradual_guarantee_part_one}
  If $[[G |- t : A]]$, $[[t <= t']]$, and $[[G <= G']]$ then $[[G' |- t' : B]]$ and $[[A <= B]]$.
\end{lemma}
\begin{proof}
  This is a proof by induction on $[[G |- t : A]]$.

  \begin{itemize}
  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXvarPName{}$] {
          [[x : A elem G && G Ok]]
        }{[[G |- x : A]]}
      \end{math}
    \end{center}
    In this case $[[t]] = [[x]]$.  Suppose $[[t <= t']]$.  Then
    it must be the case that $[[t']] = [[x]]$.  If $[[x : A elem G]]$,
    then there is a type $[[A']]$ such that $[[x : A' elem G']]$ and
    $[[A <= A']]$.  Thus, choose $[[B]] = [[A']]$ and the result follows.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXsuccName{}$] {
          [[G |- t1 : A' && nat(A') = Nat]]
        }{[[G |- succ t1 : Nat]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[Nat]]$ and $[[t]] = [[succ t1]]$.  Suppose $[[t <= t']]$ and $[[G <= G']]$.
    Then by definition it must be the case that $[[t']] = [[succ t2]]$ where $[[t1 <= t2]]$.
    By the induction hypothesis $[[G' |- t2 : B']]$ where $[[A' <= B']]$.  Since $[[nat(A') = Nat]]$
    and $[[A' <= B']]$, then it must be the case that $[[nat(B') = Nat]]$ by Lemma~\ref{lemma:fun_type_pre}.
    At this point we obtain our result by choosing $[[B]] = [[Nat]]$, and reapplying the rule above.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXncaseName{}$] {
          [[(G |- t1 : C  && nat(C) = Nat) && G |- A1 ~ A]]
          \\\\
          [[(G |- t2 : A1 && G, x : Nat |- t3 : A2) && G |- A2 ~ A]]
        }{[[G |- case t1 of 0 -> t2, (succ x) -> t3 : A]]}
      \end{math}
    \end{center}
    In this case $[[t]] = [[case t1 of 0 -> t2, (succ x) -> t3]]$.  Suppose $[[t <= t']]$ and $[[G <= G']]$.  This
    implies that $[[t']] = [[case t1' of 0 -> t2', (succ x) -> t3']]$ such that
    $[[t1 <= t1']]$, $[[t2 <= t2']]$, and $[[t3 <= t3']]$.  Since $[[G <= G']]$ then $[[(G,x:Nat) <= (G',x:Nat)]]$.
    By the induction hypothesis we know the following:
    \begin{center}
      \begin{tabular}{lll}
        $[[G' |- t1' : C']]$ for $[[C <= C']]$\\
        $[[G' |- t2 : A1']]$ for $[[A1 <= A1']]$\\
        $[[G', x : Nat |- t3 : A2']]$ for $[[A2 <= A2']]$
      \end{tabular}
    \end{center}
    By assumption we know that $[[G |- A1 ~ A]]$, $[[G |- A2 ~ A]]$, and $[[G <= G']]$,
    hence, by Lemma~\ref{lemma:type_cons_ctx_pre} we know $[[G' |- A1 ~ A]]$ and $[[G' |- A2 ~ A]]$.  
    By the induction hypothesis we know that $[[A1 <= A1']]$ and $[[A2 <= A2']]$, so
    by using Lemma~\ref{lemma:type_cons_type_pre_2} we may obtain that
    $[[G' |- A1' ~ A]]$ and $[[G' |- A2' ~ A]]$.  At this point choose $[[B]] = [[A]]$
    and we obtain our result by reapplying the rule.
    
  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXconsName{}$] {
          [[((G |- t1 : A1 && G |- t2 : A2) && list(A2) = List A3) && G |- A1 ~ A3]]
        }{[[G |- t1 :: t2 : List A3]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[List A3]]$ and $[[t]] = [[t1 :: t2]]$.  Suppose $[[t <= t']]$ and $[[G <= G']]$.
    Then it must be the case that $[[t']] = [[t1' :: t2']]$ where $[[t1 <= t1']]$ and
    $[[t2 <= t2']]$.  Then by the induction hypothesis we know the following:
    \begin{center}
      \begin{tabular}{lll}
        $[[G' |- t1' : A1']]$ where $[[A1 <= A1']]$\\
        $[[G' |- t2' : A2']]$ where $[[A2 <= A2']]$\\
      \end{tabular}
    \end{center}
    By Lemma~\ref{lemma:fun_type_pre} $[[list(A2') = List A3']]$ where $[[A3 <= A3']]$.
    Now by Lemma~\ref{lemma:type_cons_ctx_pre} and Lemma~\ref{lemma:type_cons_type_pre_2} we know that
    $[[G' |- A1' ~ A3]]$, and by using the same lemma again, $[[G' |- A1' ~ A3']]$
    because $[[G' |- A3 ~ A1']]$ holds by symmetry.  Choose $[[B]] = [[List A3']]$
    and the result follows.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXpairName{}$] {
          [[G |- t1 : A1 && G |- t2 : A2]]
        }{[[G |- (t1,t2) : A1 x A2]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[A1 x A2]]$ and $[[t]] = [[(t1,t2)]]$. Suppose
    $[[t <= t']]$ and $[[G <= G']]$.  This implies that $[[t']] = [[(t1',t2')]]$ where
    $[[t1 <= t1']]$ and $[[t2 <= t2']]$.
    
    By the induction hypothesis we know:
    \begin{center}
      \begin{tabular}{lll}
        $[[G' |- t1' : A1']]$ and $[[A1 <= A1']]$\\
        $[[G' |- t2' : A2']]$ and $[[A2 <= A2']]$\\
      \end{tabular}
    \end{center}
    Then choose $[[B]] = [[A1' x A2']]$ and the result follows by reapplying
    the rule above and the fact that $[[(A1 x A2) <= (A1' x A2')]]$.  

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXlamName{}$] {
          [[G, x : A1 |- t1 : B1]]
        }{[[G |- \x:A1.t1 : A1 -> B1]]}
      \end{math}
    \end{center}
    In this case $[[A1 -> B2]]$ and $[[t]] = [[\x:A1.t1]]$.  Suppose $[[t <= t']]$ and $[[G <= G']]$.
    Then it must be the case that $[[t']] = [[\x:A2.t2]]$, $[[t1 <= t2]]$, and $[[A1 <= A2]]$.
    Since $[[G <= G']]$ and $[[A1 <= A2]]$, then $[[(G, x : A1) <= (G', x : A2)]]$ by definition.
    Thus, by the induction hypothesis we know the following:
    \begin{center}
      \begin{tabular}{lll}
        $[[G', x : A2 |- t1' : B2]]$ and $[[B1 <= B2]]$
      \end{tabular}
    \end{center} 
    Choose $[[B]] = [[A2 -> B2]]$ and the result follows by reapplying the rule above
    and the fact that $[[(A1 -> B1) <= (A2 -> B2)]]$.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXtypeAppName{}$] {
          [[G |- t1 : Forall (X<:C0).C2 && G |- C1 <~ C0]]
        }{[[G |- [C1]t1 : [C1/X]C2]]}
      \end{math}
    \end{center}
    In this case $[[t]] = [[ [C1]t1]]$.  Suppose $[[t <= t']]$ and $[[G <= G']]$.
    Then it must be the case that $[[t']] = [[ [C1']t2]]$ such that $[[t1 <= t2]]$
    and $[[C1 <= C1']]$.  By the induction hypothesis:
    \begin{center}
      \begin{tabular}{lll}
        $[[G' |- t2 : C]]$ where $[[Forall (X<:C0).C2 <= C]]$
      \end{tabular}
    \end{center}
    Thus, it must be the case that $[[C]] = [[Forall (X <: C0).C2']]$ such that $[[C2 <= C2']]$.
    By assumption we know that $[[G |- C1 <~ C0]]$ and $[[C1 <= C1']]$, and thus,
    by Corollary~\ref{corollary:congruence_of_subtyping_along_type_precision} and Lemma~\ref{lemma:subtyping_context_precision}
    we know $[[G' |- C1' <~ C0]]$.  Thus, choose $[[B]] = [[C]]$, and the result follows by reapplying
    the rule above, and the fact that $[[A <= C]]$, because $[[C2 <= C2']]$.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXSubName{}$] {
          [[G |- t : A' && G |- A' <~ A]]
        }{[[G |- t : A]]}
      \end{math}
    \end{center}
    Suppose $[[t <= t']]$ and $[[G <= G']]$.
    By the induction hypothesis we know that $[[G' |- t' : A'']]$ for $[[A' <= A'']]$.
    We know $[[A'' <= A]]$ or $[[A <= A'']]$, because we know that $[[G |- A' <~ A]]$
    and $[[A' <= A'']]$.   Suppose $[[A'' <= A]]$, then by Corollary~\ref{corollary:type_precision_and_subtyping}
    $[[G' |- A'' <~ A]]$, and then by subsumption $[[G' |- t' : A]]$, hence, choose $[[B]] = [[A]]$
    and the result follows.  If $[[A <= A'']]$, then choose $[[B]] = [[A'']]$ and the result follows.

  \item[] Case.\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=$\SGradydruleTXXappName{}$] {
          [[G |- t1 : C && fun(C) = A1 -> B1]]
          \\\\
         [[G |-t2 : A2 && G |- A2 ~ A1]]
        }{[[G |- t1 t2 : B1]]}
      \end{math}
    \end{center}
    In this case $[[A]] = [[B1]]$ and $[[t]] = [[t1 t2]]$.  Suppose $[[t <= t']]$
    and $[[G <= G']]$.  The former implies that $[[t']] = [[t1' t2']]$ such that
    $[[t1 <= t1']]$ and $[[t2 <= t2']]$.  By the induction hypothesis we know the
    following:
    \begin{center}
      \begin{tabular}{lll}
        $[[G' |- t1' : C']]$ for $[[C <= C']]$\\
        $[[G' |- t2' : A2']]$ for $[[A2 <= A2']]$\\
      \end{tabular}
    \end{center}
    We know by assumption that $[[G |- A2 ~ A1]]$ and hence $[[G' |- A2 ~ A1]]$
    because bounds on type variables are left unchanged by context precision.
    Since $[[C <= C']]$ and $[[fun(C) = A1 -> B1]]$, then $[[fun(C') = A1' -> B1']]$
    where $[[A1 <= A1']]$ and $[[B1 <= B1']]$ by Lemma~\ref{lemma:fun_type_pre}.
    Furthermore, we know $[[G' |- A2 ~ A1]]$ and $[[A2 <= A2']]$ and $[[A1 <= A1']]$, then
    we know $[[G' |- A2' ~ A1']]$ by Corollary~\ref{corollary:congruence_of_type_consistency_along_type_precision}.
    So choose $[[B]] = [[B1']]$. Then reapply the rule above and the result follows, because
    $[[B1 <= B1']]$.
  \end{itemize}
\end{proof}

\begin{theorem}[Gradual Guarantee]
  \label{thm:gradual_guarantee}
  Suppose $[[. |- t : A]]$ and $[[t <= t']]$.  Then
  \begin{enumR}
  \item $[[. |- t' : B]]$ and $[[A <= B]]$,
  \item if $[[t ~>* v]]$, then $[[t' ~>* v']]$ and $[[v <= v']]$,
  \item if $[[t ^]]$, then $[[t' ^]]$,
  \item if $[[t' ~>* v']]$, then $[[t ~>* v]]$ where $[[v <= v']]$, or $<<t ~>* error>>$, and
  \item if $[[t' ^]]$, then $[[t ^]]$ or $<<t ~>* error>>$.
  \end{enumR}
\end{theorem}
\begin{proof}
  
\end{proof}

%%% Local Variables: ***
%%% mode:latex ***
%%% TeX-master: "main.tex"  ***
%%% End: ***
