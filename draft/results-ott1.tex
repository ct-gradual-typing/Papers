\begin{lemma}[Inclusion of Bounded System F]
  \label{lemma:F-inclusion}
  Suppose $t$ is fully annotated and does not contain any applications
  of $ \mathsf{box} $ or $ \mathsf{unbox} $, and $\SGradynt{A}$ is static.  Then
  \begin{itemize}
  \item[i.] $ \Gamma  \vdash_F  \SGradynt{t}  :  \SGradynt{A} $ if and only if $\, \Gamma  \vdash  \SGradynt{t}  :  \SGradynt{A} $, and 
  \item[ii.] $ \SGradynt{t}  \rightsquigarrow^*_F  \SGradynt{t'} $ if and only if $ \SGradynt{t}  \rightsquigarrow^*  \SGradynt{t'} $.
  \end{itemize}
\end{lemma}
\begin{proof}
  We give proof sketches for both parts.  The interesting cases are
  the right-to-left directions of each part.  If we simply remove all
  rules mentioning the unknown type $\SGradysym{\mbox{?}}$ and the type consistency
  relation, and then remove $ \mathsf{box} $, $ \mathsf{unbox} $, and $\SGradysym{\mbox{?}}$ from
  the syntax of Surface Grady, then what we are left with is bounded
  system F.  Since $\SGradynt{t}$ is fully annotated and $\SGradynt{A}$ is static,
  then $ \Gamma  \vdash  \SGradynt{t}  :  \SGradynt{A} $ will hold within this fragment.

  Moving on to part two, first, we know that $\SGradynt{t}$ does not contain
  any occurrence of $ \mathsf{box} $ or $ \mathsf{unbox} $ and is fully annotated.
  This implies that $\SGradynt{t}$ lives within the bounded system F fragment
  of Surface Grady. Thus, before evaluation of $\SGradynt{t}$ Surface Grady
  will apply the cast insertion algorithm which will at most insert
  applications of the identity function into $\SGradynt{t}$ producing a term
  $\widehat{\SGradynt{t}}$, but then after potentially more than one step of
  evaluation within Core Grady, those applications of the identity
  function will be $\beta$-reduced away resulting in $\widehat{\SGradynt{t}}
  \rightsquigarrow^* \SGradynt{t} \rightsquigarrow^* \SGradynt{t'}$.  In addition,
  since $\SGradynt{t}$ in Surface Grady is the exact same program as $\SGradynt{t}$
  in bounded system F, then we know $ \SGradynt{t}  \rightsquigarrow^*_F  \SGradynt{t'} $ will hold.
\end{proof}

\begin{lemma}[Inclusion of DTLC]
  \label{lemma:inclusion_of_dtlc}
  Suppose $\SGradynt{t}$ is a closed term of DTLC. Then
  \begin{itemize}
  \item[i.] $  \cdot   \vdash   \lceil  \SGradynt{t}  \rceil   :  \SGradysym{\mbox{?}} $, and
  \item[ii.] $ \SGradynt{t}  \rightsquigarrow^*_{DTLC}  \SGradynt{t'} $ if and only if $  \lceil  \SGradynt{t}  \rceil   \rightsquigarrow^*   \lceil  \SGradynt{t'}  \rceil  $.
  \end{itemize}
\end{lemma}
\begin{proof}
  In this case DTLC is embedded into the simply typed fragment of
  Grady, and hence, this proof is the same result proven by
  \cite{Siek:2006}, and \cite{Siek:2015}.
\end{proof}

\renewcommand{\SGradydrulePXXUName}{\SGradysym{\mbox{?}}}
\renewcommand{\SGradydrulePXXreflName}{\text{refl}}
\renewcommand{\SGradydrulePXXarrowName}{\to}
\renewcommand{\SGradydrulePXXprodName}{\times}
\renewcommand{\SGradydrulePXXlistName}{\mathsf{List}}
\renewcommand{\SGradydrulePXXforallName}{\forall}
\begin{figure}
  \begin{mdframed}
    \begin{mathpar}
      \SGradydrulePXXU{} \and
      \SGradydrulePXXrefl{} \and
      \SGradydrulePXXarrow{} \and
      \SGradydrulePXXprod{} \and
      \SGradydrulePXXlist{} \and
      \SGradydrulePXXforall{}      
    \end{mathpar}
  \end{mdframed}
  \caption{Type Precision}
  \label{fig:type-pre}
\end{figure}

\begin{lemma}[Left-to-Right Consistent Subtyping]
  \label{lemma:consistent-subtyping-1}
  Suppose $ \Gamma  \vdash  \SGradynt{A}  \lesssim  \SGradynt{B} $.
  \begin{enumR}
    \item $ \Gamma  \vdash  \SGradynt{A}  \sim  \SGradynt{A'} $ and $[[G |- A' <: B]]$ for some $\SGradynt{A'}$.
    \item $ \Gamma  \vdash  \SGradynt{B'}  \sim  \SGradynt{B} $ and $[[G |- A <: B']]$ for some $\SGradynt{B'}$.
  \end{enumR}   
\end{lemma}
\begin{proof}
  This is a proof by induction on $ \Gamma  \vdash  \SGradynt{A}  \lesssim  \SGradynt{B} $.  See
  Appendix~\ref{subsec:proof_of_left-to-right_consistent_subtyping_lemma:consistent-subtyping-1}
  for the complete proof.
\end{proof}

\begin{corollary}[Consistent Subtyping]
  \label{corollary:consistent_subtyping}
  \begin{enumR}
  \item[]
  \item $ \Gamma  \vdash  \SGradynt{A}  \lesssim  \SGradynt{B} $ if and only if $ \Gamma  \vdash  \SGradynt{A}  \sim  \SGradynt{A'} $ and $[[G |- A' <: B]]$ for some $\SGradynt{A'}$.
  \item $ \Gamma  \vdash  \SGradynt{A}  \lesssim  \SGradynt{B} $ if and only if $ \Gamma  \vdash  \SGradynt{B'}  \sim  \SGradynt{B} $ and $[[G |- A <: B']]$ for some $\SGradynt{B'}$.
  \end{enumR}
\end{corollary}
\begin{proof}
  The left-to-right direction of both cases easily follows from
  Lemma~\ref{lemma:consistent-subtyping-1}, and the right-to-left
  direction of both cases follows from induction on the subtyping
  derivation and Lemma~\ref{lemma:simply_typed_consistent_types_are_subtypes}.
\end{proof}

\begin{lemma}[Congruence of Type Consistency Along Type Precision]
  \label{lemma:congruence_of_type_consistency_along_type_precision}
  \begin{enumR}
  \item[] 
  \item If $ \SGradynt{A_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{A'_{{\mathrm{1}}}} $ and $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{1}}}}  \sim  \SGradynt{A_{{\mathrm{2}}}} $ then
    $ \Gamma  \vdash  \SGradynt{A'_{{\mathrm{1}}}}  \sim  \SGradynt{A_{{\mathrm{2}}}} $.
    
  \item If $ \SGradynt{A_{{\mathrm{2}}}}  \sqsubseteq  \SGradynt{A'_{{\mathrm{2}}}} $ and $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{1}}}}  \sim  \SGradynt{A_{{\mathrm{2}}}} $ then
    $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{1}}}}  \sim  \SGradynt{A'_{{\mathrm{2}}}} $.  
  \end{enumR}
\end{lemma}
\begin{proof}
  Both parts hold by induction on the assumed type consistency
  judgment.  See
  Appendix~\ref{subsec:proof_of_congruence_of_type_consistency_along_type_precision_lemma:congruence_of_type_consistency_along_type_precision}
  for the complete proof.
\end{proof}

\begin{corollary}[Congruence of Type Consistency Along Type Precision Condensed]
  \label{corollary:congruence_of_type_consistency_along_type_precision}
  If $ \SGradynt{A_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{A'_{{\mathrm{1}}}} $, $ \SGradynt{A_{{\mathrm{2}}}}  \sqsubseteq  \SGradynt{A'_{{\mathrm{2}}}} $, and $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{1}}}}  \sim  \SGradynt{A_{{\mathrm{2}}}} $ then
  $ \Gamma  \vdash  \SGradynt{A'_{{\mathrm{1}}}}  \sim  \SGradynt{A'_{{\mathrm{2}}}} $.  
\end{corollary}

\begin{lemma}[Congruence of Subtyping Along Type Precision]
  \label{lemma:congruence_of_subtyping_along_type_precision}
  Suppose $ \Gamma  \vdash  \SGradynt{B}  : \star $ and $ \SGradynt{A}  \sqsubseteq  \SGradynt{B} $.
  \begin{enumR}
  \item If $ \Gamma  \vdash  \SGradynt{A}  \lesssim  \SGradynt{C} $ then $ \Gamma  \vdash  \SGradynt{B}  \lesssim  \SGradynt{C} $.

  \item If $ \Gamma  \vdash  \SGradynt{C}  \lesssim  \SGradynt{A} $ then $ \Gamma  \vdash  \SGradynt{C}  \lesssim  \SGradynt{B} $.  
  \end{enumR}
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of $ \SGradynt{A}  \sqsubseteq  \SGradynt{B} $; see
  Appendix~\ref{subsec:proof_of_congruence_of_subtyping_along_type_precision_lemma:congruence_of_subtyping_along_type_precision}
  for the complete proof.
\end{proof}

\begin{corollary}[Congruence of Subtyping Along Type Precision]
  \label{corollary:congruence_of_subtyping_along_type_precision}
  If $ \SGradynt{A_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{A_{{\mathrm{2}}}} $, $ \SGradynt{B_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{B_{{\mathrm{2}}}} $, and $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{1}}}}  \lesssim  \SGradynt{B_{{\mathrm{1}}}} $, then $ \Gamma  \vdash  \SGradynt{A_{{\mathrm{2}}}}  \lesssim  \SGradynt{B_{{\mathrm{2}}}} $.
\end{corollary}

\begin{lemma}[Gradual Guarantee Part One]
  \label{lemma:gradual_guarantee_part_one}
  If $ \Gamma  \vdash  \SGradynt{t}  :  \SGradynt{A} $, $ \SGradynt{t}  \sqsubseteq  \SGradynt{t'} $, and $ \Gamma  \sqsubseteq  \Gamma' $ then $ \Gamma'  \vdash  \SGradynt{t'}  :  \SGradynt{B} $ and $ \SGradynt{A}  \sqsubseteq  \SGradynt{B} $.
\end{lemma}
\begin{proof}
  This is a proof by induction on $ \Gamma  \vdash  \SGradynt{t}  :  \SGradynt{A} $; see
  Appendix~\ref{subsec:proof_of_gradual_guarantee_part_one_lemma:gradual_guarantee_part_one}
  for the complete proof.
\end{proof}

\begin{lemma}[Type Preservation for Cast Insertion]
  \label{lemma:type_preservation_for_cast_insertion}
  If $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{1}}}}  :  \SGradynt{A} $ and $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{1}}}}  \Rightarrow  \SGradynt{t_{{\mathrm{2}}}}  :  \SGradynt{A} $, then $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{2}}}}  :  \SGradynt{A} $.
\end{lemma}


\begin{lemma}[Gradual Guarantee Part Two]
  \label{lemma:gradual_guarantee_part_two}
  If $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{1}}}}  :  \SGradynt{A} $, $ \SGradynt{t_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{t_{{\mathrm{2}}}} $, $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{1}}}}  \Rightarrow  \SGradynt{t'_{{\mathrm{1}}}}  :  \SGradynt{A} $, $ \Gamma  \vdash  \SGradynt{v_{{\mathrm{1}}}}  \Rightarrow  \SGradynt{v'_{{\mathrm{1}}}}  :  \SGradynt{A} $, and $ \SGradynt{t'_{{\mathrm{1}}}}  \rightsquigarrow^*  \SGradynt{v'_{{\mathrm{1}}}} $, then
  $ \Gamma  \vdash  \SGradynt{t_{{\mathrm{2}}}}  \Rightarrow  \SGradynt{t'_{{\mathrm{2}}}}  :  \SGradynt{A} $, $ \Gamma  \vdash  \SGradynt{v_{{\mathrm{2}}}}  \Rightarrow  \SGradynt{v'_{{\mathrm{2}}}}  :  \SGradynt{A} $, $ \SGradynt{t'_{{\mathrm{2}}}}  \rightsquigarrow^*  \SGradynt{v'_{{\mathrm{2}}}} $, and $ \SGradynt{v_{{\mathrm{1}}}}  \sqsubseteq  \SGradynt{v_{{\mathrm{2}}}} $.
\end{lemma}


\begin{theorem}[Gradual Guarantee]
  \label{thm:gradual_guarantee}
  Suppose $  \cdot   \vdash  \SGradynt{t}  :  \SGradynt{A} $ and $ \SGradynt{t}  \sqsubseteq  \SGradynt{t'} $.  Then
  \begin{enumR}
  \item $  \cdot   \vdash  \SGradynt{t'}  :  \SGradynt{B} $ and $ \SGradynt{A}  \sqsubseteq  \SGradynt{B} $,
  \item if $ \SGradynt{t}  \rightsquigarrow^*  \SGradynt{v} $, then $ \SGradynt{t'}  \rightsquigarrow^*  \SGradynt{v'} $ and $ \SGradynt{v}  \sqsubseteq  \SGradynt{v'} $,
  \item if $ \SGradynt{t}  \uparrow $, then $ \SGradynt{t'}  \uparrow $,
  \item if $ \SGradynt{t'}  \rightsquigarrow^*  \SGradynt{v'} $, then $ \SGradynt{t}  \rightsquigarrow^*  \SGradynt{v} $ where $ \SGradynt{v}  \sqsubseteq  \SGradynt{v'} $, or $[[t ~>* error]]$, and
  \item if $ \SGradynt{t'}  \uparrow $, then $ \SGradynt{t}  \uparrow $ or $[[t ~>* error]]$.
  \end{enumR}
\end{theorem}
\begin{proof}
  Part one holds by Lemma~\ref{lemma:gradual_guarantee_part_one}.
\end{proof}

%%% Local Variables: ***
%%% mode:latex ***
%%% TeX-master: "main.tex"  ***
%%% End: ***
